{% extends "base.html" %}

{% block title %}–ü–ª–∞—Ç–µ–∂–∏ –ø–æ —Ç–æ–≤–∞—Ä—É{% endblock %}

{% block content %}
<div class="client-product-card card border-0 shadow-sm mb-4">
  <!-- –ë–ª–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>–ö–ª–∏–µ–Ω—Ç: {{ item.client_name }}</h5>
  </div>

  <div class="card-body">
    <!-- –ë–ª–æ–∫ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="product-section mb-4 p-1 bg-light rounded">
      <h6 class="d-flex align-items-center mb-1">
        <i class="fas fa-box-open text-primary me-2"></i>
        <strong>–¢–æ–≤–∞—Ä:</strong>
        <span class="ms-2">{{ item.name }}</span>
      </h6>
    </div>

    <!-- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="far fa-calendar text-muted me-2"></i><strong>–î–∞—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:</strong></span>
        <span class="value-badge fs-6">{{ item.created_at.strftime('%d.%m.%Y') }}</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-tag text-muted me-2"></i><strong>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∞:</strong></span>
        <span class="value-badge fs-8">{{ item.purchase_price | rub }}</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-credit-card text-muted me-2"></i><strong>–¶–µ–Ω–∞ –≤ —Ä–∞—Å—Å—Ä–æ—á–∫—É:</strong></span>
        <span class="value-badge fs-8">{{ item.price | rub }}</span>
      </li>

      {% if item.down_payment %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-hand-holding-usd text-muted me-2"></i><strong>–í–∑–Ω–æ—Å:</strong></span>
        <span class="value-badge fs-8">{{ item.down_payment | rub }}</span>
      </li>
      {% endif %}

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="far fa-calendar-alt text-muted me-2"></i><strong>–°—Ä–æ–∫ —Ä–∞—Å—Å—Ä–æ—á–∫–∏:</strong></span>
        <span class="value-badge fs-8">{{ item.installments }} –º–µ—Å.</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-check-circle text-muted me-2"></i><strong>–û–ø–ª–∞—á–µ–Ω–æ:</strong></span>
        <span class="value-badge fs-8">{{ total_paid | rub }}</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-week text-muted me-2"></i><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong></span>
        <span class="value-badge fs-8">{{ (remaining or 0) | rub }}</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-week text-muted me-2"></i><strong>–ü—Ä–∏–±—ã–ª—å –≤ –º–µ—Å—è—Ü:</strong></span>
        <span class="value-badge fs-8">
          {% if (item.installments or 0) > 0 %}
            {{ (((item.price or 0) - (item.purchase_price or 0)) / item.installments) | round(2) | rub }}
          {% else %}
            ‚Äî
          {% endif %}
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-line text-muted me-2"></i><strong>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å:</strong></span>
        <span class="badge bg-success fs-6">{{ ((item.price or 0) - (item.purchase_price or 0)) | rub }}</span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-info-circle text-muted me-2"></i><strong>–°—Ç–∞—Ç—É—Å:</strong></span>
        <span class="status-badge">
          {{ item.status }}
        </span>
      </li>
    </ul>
  </div>
</div>

<style>
.client-product-card {
  border-radius: 10px;
  overflow: hidden;
  transition: transform 0.3s ease;
}
.client-product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.product-section {
  background-color: #f8f9fa;
  border-left: 3px solid #0d91fd;
}
.list-group-item {
  padding: 1rem 1.25rem;
  border-left: none;
  border-right: none;
}
.value-badge {
  background-color: #ffffff;
  color: #101010;
  padding: 0.4em 0.8em;
  border-radius: 50px;
  font-weight: 500;
  font-size: 0.9em;
  min-width: 80px;
  text-align: center;
}
.status-badge {
  padding: 0.4em 0.8em;
  border-radius: 50px;
  font-size: 0.9em;
  font-weight: 500;
  background-color: {% if item.status == '–ê–∫—Ç–∏–≤–µ–Ω' %}#d1e7dd{% elif item.status == '–ó–∞–≤–µ—Ä—à–µ–Ω' %}#e2e3e5{% elif item.status == '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω' %}#f8d7da{% else %}#cfe2ff{% endif %};
  color: {% if item.status == '–ê–∫—Ç–∏–≤–µ–Ω' %}#0f5132{% elif item.status == '–ó–∞–≤–µ—Ä—à–µ–Ω' %}#41464b{% elif item.status == '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω' %}#842029{% else %}#084298{% endif %};
}
</style>

<h4>–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h4>
<form method="POST">
  <input type="hidden" name="add_payment" value="1">

  <div class="mb-2">
    <label for="amount">–°—É–º–º–∞:</label>
    <input type="number" name="amount" step="0.01" class="form-control" required id="amount-input">

    <div class="mt-2">
      <strong>–ü—Ä–∏–±—ã–ª—å —Å –ø–ª–∞—Ç–µ–∂–∞:</strong> <span id="payment-profit">‚Äî</span>
    </div>
  </div>

  <div class="mb-2">
    <label for="created_at">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
    <input type="date" name="created_at" class="form-control" value="{{ current_date }}">
  </div>

  {% if current_user.active_license and current_user.active_license.is_active %}
    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
  {% else %}
    <button type="button" class="btn btn-secondary" disabled>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</button>
  {% endif %}
</form>

<hr>

<h4>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h4>
<a href="{{ url_for('export_pdf', item_id=item.id) }}" class="btn btn-primary">üìÑ –°–∫–∞—á–∞—Ç—å PDF</a>
{% if item.client_phone %}
  <a href="{{ url_for('whatsapp_link', item_id=item.id) }}" class="btn btn-success">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</a>
{% endif %}

<table class="table table-bordered mt-2">
  <thead>
    <tr>
      <th>#</th>
      <th>–î–∞—Ç–∞</th>
      <th>–°—É–º–º–∞</th>
      <th>–°—Ç–∞—Ç—É—Å</th>
      <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
    </tr>
  </thead>
  <tbody>
    {% if payments %}
      {% for payment in payments %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ payment.created_at.strftime('%d.%m.%Y') }}</td>
          <td>{{ payment.amount }} ‚ÇΩ</td>
          <td>
            {% if total_paid >= (item.price or 0) %}
              <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ</span>
            {% else %}
              <span class="badge bg-warning text-dark">–ß–∞—Å—Ç–∏—á–Ω–æ</span>
            {% endif %}
          </td>
          <td onclick="event.stopPropagation()">
            <div class="d-flex gap-2">
              <button type="button"
                      class="btn btn-sm btn-outline-danger delete-payment-btn ms-3"
                      data-bs-toggle="modal"
                      data-bs-target="#deletePaymentModal{{ payment.id }}">
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </td>
        </tr>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è -->
        <div class="modal fade" id="deletePaymentModal{{ payment.id }}" tabindex="-1"
             aria-labelledby="deletePaymentLabel{{ payment.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="POST">
                <input type="hidden" name="delete_payment_id" value="{{ payment.id }}">
                <div class="modal-header">
                  <h5 class="modal-title" id="deletePaymentLabel{{ payment.id }}">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                  –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–ª–∞—Ç—ë–∂?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                  <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="text-center">–ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<a href="{{ url_for('client_detail', client_name=item.client_name) }}" class="btn btn-primary mt-1">‚Üê –ù–∞–∑–∞–¥</a>

<script>
  const amountInput = document.getElementById('amount-input');
  const profitDisplay = document.getElementById('payment-profit');

  // –î–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ (Jinja)
  const price = {{ item.price or 0 }};
  const purchasePrice = {{ item.purchase_price or 0 }};

  const markupRatio = price > 0 ? (price - purchasePrice) / price : 0;

  const formatRub = (value) =>
    new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: 'RUB',
      minimumFractionDigits: 2
    }).format(value);

  amountInput.addEventListener('input', () => {
    const amount = parseFloat(amountInput.value);
    if (!isNaN(amount)) {
      const profit = amount * markupRatio;
      profitDisplay.textContent = formatRub(profit);
    } else {
      profitDisplay.textContent = '‚Äî';
    }
  });
</script>



{% endblock %}
